# 智慧倉儲動態管理系統 2.0 - 專案架構及程式碼分析完整版 V3

本文件提供「智慧倉儲動態管理系統」的完整專案架構與核心程式碼深度分析，反映了最新的系統功能狀態（包含安全庫存警示系統、全網頁滿版響應式優化、以及全新的手機版掃描作業介面）。

---

## 一、 專案目錄結構概觀

本專案採用前後端分離（Client-Server）架構設計：
- **前端 (Client)**: 建立於 `React.js` + `Vite` + `TailwindCSS`，並整合了 `html5-qrcode` 實現行動裝置掃描。
- **後端 (Server)**: 建立於 `Node.js` + `Express.js` + `better-sqlite3`。

```text
智慧倉儲動態管理系統2.0/
├── client/                     # 前端 React 應用程式 (Vite)
│   ├── src/
│   │   ├── api.js              # 集中管理所有與後端溝通的 Axios API 請求
│   │   ├── components/         # 可共用的 UI 元件 (如: MapGrid.jsx, Layout.jsx, ProtectedRoute.jsx)
│   │   ├── pages/              # 各個獨立路由頁面 (如: 總覽看板, 庫存查詢, 資料匯入中心等)
│   │   │   └── MobileScanner.jsx # 全新⭐：專為手機版設計的掃描出入庫操作頁面
│   │   ├── App.jsx             # React 路由 (React Router) 的根節點與權限管理入口
│   │   ├── index.css           # 全域樣式與 Tailwind 指令庫
│   │   └── main.jsx            # React 應用的進入點
│   ├── package.json            # 前端依賴配置 (包含 html5-qrcode)
│   └── vite.config.js          # Vite 構建配置 (加上 @vitejs/plugin-basic-ssl 支援手機 HTTPS 鏡頭調用)
│
├── server/                     # 後端 Node.js 應用程式
│   ├── server.js               # Express 核心伺服器，包含所有 API 路由與資料庫連線/遷移邏輯
│   ├── warehouse.db            # SQLite 資料庫主檔 (better-sqlite3)
│   └── package.json            # 後端依賴配置
│
├── input/                      # 存放供系統匯入的 Excel 原始資料檔 (料件、盤點、儲位圖等)
├── run_locally.bat             # 一鍵啟動腳本 (包含 Node.js 路徑動態偵測機制與依賴安裝)
└── .node_path                  # 自動生成的 Node.js 執行路徑快取檔
```

---

## 二、 資料結構演進與資料庫架構 (SQLite)

後端採用 `better-sqlite3` 進行輕量且高效的本機資料庫操作，所有的資料表結構定義於 `server.js` (`initDb` 函數) 內，並備有自動遷移機制 (Migrations)。

### 核心資料表 (Tables)

1. **`users` (使用者表)**
   - 記錄 `employee_id`(工號/帳號), `password`(密碼), `permissions`(JSON 格式的權限陣列), `group_name`(群組：如管理者/一般使用者)。

2. **`items` (料件主檔)**
   - 記錄 `barcode` (料號，唯一鍵), `name` (品名), `description` (規格), `category` (庫別), `unit` (單位)。
   - ⭐ **新增**: `safe_stock` (安全庫存量)。引入了自動更新/防呆機制，如果欄位未給定會預設為 0，支援於圖表與匯入匯出時動態取用。

3. **`locations` (儲位主檔)**
   - 記錄 `code` (儲位代碼), `x`, `y` (二維平面圖的網格座標), `type` (一般貨架 'SHELF' 或其他)。
   - 利用 `#V_#` 的虛擬代碼用來對應 UI 的大型走道與牆壁等空間。

4. **`inventory` (庫存表)**
   - 作為 `items` 和 `locations` 的關聯表，記錄 `(item_id, location_id, quantity)`。
   - 保證了同一儲位可以存放多種料件，同一料件也可分散在多個儲位。

5. **`transactions` (異動紀錄表)**
   - 記錄每次的 `IN` 或 `OUT` 操作 (`item_id`, `location_id`, `quantity`, `type`, `user_id`, `timestamp`)。
   - 支援**軟刪除 (Soft Delete)** 機制，可作廢操作並還原庫存量。

6. **`bom_items` (BOM 表/配方表)**
   - 定義產品結構 (`main_barcode` 主件 -> `component_barcode` 元件 -> `required_qty` 需求數量)。

---

## 三、 後端核心邏輯分析 (`server.js`)

`server.js` 是一個單體式 (Monolithic) 的 Express 伺服器，負責所有資料處理。

### 1. 資料匯入與更新機制
* **安全庫存整合**: `/api/admin/import/items` 批次匯入時，能自動正確擷取 Excel 新增的「安全庫存」欄位，並針對既有的舊料件確保預設為 0，不影響舊模組。
* **交易 (Transaction) 包裝**: 各項匯入功能使用 `db.transaction(() => {...})` 包裝迴圈中的多筆 `db.prepare().run()`，確保要麼全部成功，要麼全部回滾。

### 2. 資料查詢與警示報表
* **進階 API 端點 (`/api/items/:barcode/safe-stock`)**: 建立單一欄位 Patch 修改路由，讓使用者可在前端總表中直接「就地編輯」儲存安全庫存。
* **報表聯集查詢 (`/api/reports/inventory`)**: 運用 `LEFT JOIN` 同時串接 `items`, `inventory`, `locations` 三張表，於一次請求內吐出包含 `safe_stock` 屬性的庫存資料。

---

## 四、 前端亮點功能與演進分析 (React)

本次 V3 更新的前端重點在於**視覺升級 (滿版布局 + 警示色系)** 與 **行動裝置友善**。

### 1. 行動版掃描介面 (`pages/MobileScanner.jsx`)
這是一個全新建立的頁面，大幅提升了倉儲作業彈性。
* **安全憑證 (`vite.config.js`)**: 啟用 `basicSsl()` 擴充，強制開發環境可透過 Local IP 提供 `HTTPS` 連線，破解了 iOS 對於讀取相機的嚴格網頁規範。
* **原生 Html5Qrcode 套件串接**: 
  - 繞過了上層的 Scanner 元件，透過核心 `Html5Qrcode` 的 `setInterval` 與 `setTimeout` 自己刻了效能最佳化掃描迴圈。
  - 對 `Html5QrcodeSupportedFormats` 定義了包含 Code 128、Code 39 及 QR Code 所有的支援，滿足各種工業條碼與平面圖儲位標籤。
* **React 渲染競爭解決 (Race Condition)**:
  - 由於畫面由 React 控管而相機框由套件控管，透過 `useEffect` 與 `setTimeout(..., 300)` 設計了安全的相機掛載延遲，避免重置畫面時相機模組找不到 `#reader` 元素而當機。
* **UX 防呆與防錯**:
  - 自帶視覺重掃重設 (藉由點選 1.料件 2.儲位的卡片)。
  - **庫存分佈速覽**: 在掃完前兩步驟後，除了數量確認外，還會列出該料件「目前所有有庫存的儲位明細」，避免出庫時挑選了數量不足的儲位產生負庫存。

### 2. 動態地圖渲染核心 (`components/MapGrid.jsx`)
* **動態網格計算**: 前端收到後端傳來的散落 `(x, y)` 座標後，透過 `Math.max` 找出邊界，動態建立一個二維陣列 (Grid Matrix)。
* 支援由其他頁面 (BOM 表出庫) 傳入 `highlights` 發布**動態 Ping 動畫指示**，讓作業員一目了然。

### 3. UI/UX 與警示升級
* **滿版顯示消除留白**: 所有大型報表 (庫存查詢、報表中心、異動歷史) 移除了原本的 `max-w-7xl` 限制，將報表完整延展貼齊螢幕兩側。
* **低庫存警示系統 (`Dashboard.jsx` & `Reports.jsx`)**:
  - `Dashboard` 新增了動態監聽，當總庫存小於安全庫存時，跳出顯眼紅色方塊。此方塊為**快捷超連結**，連動 `/reports?tab=low_stock`。
  - `Reports` 實作了真正的低於安全庫存報表，並導入匯出為 Excel 供主管端「建議採購清單」的功能。

---

## 五、 其他系統亮點與維運巧思

1. **一鍵啟動腳本 (`run_locally.bat`)**
   * 內建了**智慧型 Node.js 路徑偵測**機制。
   * 會自動尋找環境變數 (例如 `C:\Users\...\node.exe`)，如果找不到會請求使用者輸入一次路徑並快取至本地的 `.node_path` 中。
   * **並自動修正 npm PATH 問題**：由於許多封閉環境的 npm 不是全域註冊，這個批次檔也能無縫接軌套用專屬 Node 去安裝依賴。

2. **前端膠囊視覺化組件**
   * 對於複雜的資料陣列 (例如多儲位 `[4A-05-1 (5), 4A-05-2 (1)]`)，不再以生硬的字串顯示。而是實作了獨立 Parser 幫忙把括號分離，畫出一個個的 Tailwind 膠囊區塊，使頁面報表可讀性極高。

此專案展現了良好的「實用導向」架構，以輕量級的 SQLite 為核心確保安裝零門檻。最新版更大幅補齊了現代化 WMS 所需的元素：移動端作業體驗、防呆機制與自動化庫存預警。
